services:
  # ---------------- MinIO Object Storage ----------------
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - ./data:/data
    networks:
      - etl-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 5
    restart: unless-stopped

  # ---------------- STABLE HADOOP NameNode ----------------
  hadoop:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: hadoop
    hostname: namenode
    ports:
      - "9870:9870"  # NameNode UI
      - "9000:9000"  # HDFS port
    environment:
      - CORE_CONF_fs_defaultFS=hdfs://namenode:9000
      - HDFS_CONF_dfs_replication=1
      - HDFS_CONF_dfs_namenode_name_dir=file:///hadoop/dfs/name
      - HDFS_CONF_dfs_datanode_data_dir=file:///hadoop/dfs/data
    volumes:
      - hadoop_dfs_name:/hadoop/dfs/name
      - hadoop_dfs_data:/hadoop/dfs/data
    command: /entrypoint.sh hdfs namenode
    networks:
      - etl-net
    restart: unless-stopped

  # ---------------- MinIO Bucket Init ----------------
  minio-init:
    image: minio/mc:latest
    container_name: minio_init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      until /usr/bin/mc alias set minio http://minio:9000 minioadmin minioadmin; do echo 'waiting for MinIO...' && sleep 1; done;
      /usr/bin/mc mb minio/bronze minio/silver minio/gold || true;
      /usr/bin/mc policy set download minio/bronze minio/silver minio/gold || true;
      echo 'âœ… MinIO buckets ready';
      "
    networks:
      - etl-net

  # ---------------- Python ETL Service ----------------
  python-service:
    build:
      context: ./python-service
      dockerfile: Dockerfile
    container_name: python_service
    volumes:
      - ./data:/app/data
      - ./python-service:/app:ro
    environment:
      - MINIO_URL=http://minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - HDFS_NAMENODE=hdfs://namenode:9000
      - HDFS_WEB_UI=http://namenode:9870
      - HDFS_USER=hadoop
    depends_on:
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      hadoop:
        condition: service_started  # Just needs to be running
    networks:
      - etl-net
    restart: unless-stopped

  # ---------------- Jupyter Notebook ----------------
  jupyter:
    image: jupyter/base-notebook:x86_64-python-3.11.6
    container_name: jupyter_notebook
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/data
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - MINIO_URL=http://minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    depends_on:
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    networks:
      - etl-net
    restart: unless-stopped

networks:
  etl-net:
    driver: bridge

volumes:
  hadoop_dfs_name:
  hadoop_dfs_data:
